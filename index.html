<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>å…ƒç¥–BanG Dream!Chan åå®¹é“å°æ¸¸æˆ</title>
    <meta name="description" content="å…ƒç¥–è¿·ä½ åŠ¨ç”»å°æ¸¸æˆå¤åˆ»ï¼Œä½“éªŒå¢å¼º" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #4a6741;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        user-select: none;
        -webkit-user-select: none;
        overflow: hidden;
      }

      #game-wrapper {
        position: relative;
        overflow: hidden;
      }

      #game-wrapper img.board-bg {
        display: block;
        width: 960px;
        height: 540px;
        pointer-events: none;
      }

      /* æ£‹ç›˜ç½‘æ ¼åŒºåŸŸ â€” åŸºäº board1.png åƒç´ æµ‹é‡ */
      #board {
        position: absolute;
        top: 4.8%;
        left: 25.3%;
        width: 49.5%;
        height: 89.5%;
        overflow: hidden;
      }

      /* å†…éƒ¨æ£‹ç›˜å®¹å™¨ï¼šç”¨äºç›¸å¯¹å®šä½ */
      #board-inner {
        position: relative;
        width: 960px;
        height: 540px;
        margin: 0 auto;
      }

      /* ç”µæ¢¯æ¥¼å±‚åƒç´ æ•°å­—ï¼ˆæ”¹ä¸ºæ–‡æœ¬æ˜¾ç¤ºï¼Œæ”¯æŒå¤šä½ï¼‰ */
      #elevator-floor {
        position: absolute;
        left: 4.4%;
        top: 23%;
        width: 14%;
        height: 18%;
        z-index: 5;
        pointer-events: none;
        background-color: #000000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Courier New', monospace;
        /* å“åº”å¼å­—ä½“ï¼Œç›¸å¯¹äºçˆ¶å®¹å™¨ */
        font-weight: bold;
        color: #f3ae4e;
        text-shadow: 2px 2px 0 #b3742e;
        line-height: 1;
        padding: 5px;
        box-sizing: border-box;
      }
      /* æ¡Œé¢ç«¯å­—ä½“å›ºå®šå¤§å° */
      @media (min-width: 781px) {
        #elevator-floor {
          font-size: 50px;
        }
      }

      .block {
        position: absolute;
        cursor: grab;
        transition:
          left 0.18s ease-out,
          top 0.18s ease-out;
        border-radius: 6px;
        overflow: hidden;
        z-index: 1;
      }

      .block.dragging {
        transition: none;
        cursor: grabbing;
        z-index: 50;
        filter: brightness(1.05);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      }

      .block:hover {
        z-index: 10;
        filter: brightness(1.08);
      }

      .block:active {
        cursor: grabbing;
      }

      .block img {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
        pointer-events: none;
      }

      /* æ§åˆ¶é¢æ¿ â€” å³ä¾§ */
      #control-panel {
        position: absolute;
        top: 50%;
        right: 2%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        z-index: 20;
      }

      #step-label {
        color: #c4a96a;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 1px;
      }

      #step-display {
        color: #e8b74a;
        font-size: 52px;
        font-weight: 900;
        font-family: "Courier New", monospace;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        line-height: 1;
      }

      .btn {
        padding: 8px 4px;
        border: 2px solid #e8b74a;
        background: rgba(0, 0, 0, 0.6);
        color: #e8b74a;
        font-size: 14px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-family: "Microsoft YaHei", sans-serif;
        width: 90px;
        text-align: center;
      }

      .btn:hover:not(#btn-voice):not(.floor-btn) {
        background: #e8b74a;
        color: #1a1a1a;
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .btn.toggle-on {
        background: #e8b74a;
        color: #1a1a1a;
      }

      /* è‡ªå®šä¹‰æ¥¼å±‚æ§ä»¶ */
      .floor-control {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-top: 5px;
      }
      .floor-control input {
        width: 80px;
        padding: 6px 4px;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #e8b74a;
        color: #e8b74a;
        font-weight: bold;
        border-radius: 20px;
        outline: none;
        font-size: 16px;
        text-align: center;
        font-family: 'Courier New', monospace;
      }
      .floor-control .btn {
        width: auto;
        padding: 6px 12px;
        font-size: 13px;
        background: rgba(0, 0, 0, 0.6);
        border-color: #e8b74a;
        color: #e8b74a;
      }
      .floor-control .btn:hover {
        background: #e8b74a;
        color: #1a1a1a;
      }

      /* èƒœåˆ©ç»“ç®—ç•Œé¢ */
      #victory-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        z-index: 300;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
      }

      #victory-overlay.show {
        display: flex;
      }

      #victory-box {
        background: linear-gradient(135deg, #ff6b9d, #c44569);
        border: 4px solid #fff;
        border-radius: 20px;
        padding: 40px 50px;
        text-align: center;
        color: #fff;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      }

      #victory-box h2 {
        font-size: 36px;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      #victory-box p {
        font-size: 20px;
        margin-bottom: 24px;
        opacity: 0.9;
      }

      #victory-box .btn {
        font-size: 16px;
        padding: 10px 28px;
        border-color: #fff;
        color: #fff;
        background: rgba(255, 255, 255, 0.15);
        width: auto;
      }

      #victory-box .btn:hover {
        background: #fff;
        color: #c44569;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes popIn {
        from { transform: scale(0.5); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      /* ===== æ–°å¢é“¾æ¥å®¹å™¨ ===== */
      .repo-links {
        position: absolute;
        top: 8px;
        right: 2%;
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .repo-link {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 14px;
        background: rgba(0, 0, 0, 0.6);
        border: 1.5px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        text-decoration: none;
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        transition: all 0.25s ease;
        backdrop-filter: blur(6px);
        white-space: nowrap;
      }

      .repo-link:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: #e8b74a;
        color: #e8b74a;
        transform: scale(1.05);
      }

      .repo-link svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      .repo-link .star-icon {
        width: 14px;
        height: 14px;
      }

      /* Bç«™é“¾æ¥ç²‰è‰²è¾‰å…‰ */
      .bili-link {
        border-color: #fb7299;
      }

      .bili-link:hover {
        border-color: #ffa0c0;
        color: #ffa0c0;
        box-shadow: 0 0 15px #fb7299, 0 0 30px #fb7299;
      }

      .bili-link svg.play-icon {
        width: 16px;
        height: 16px;
      }

      /* å“åº”å¼é€‚é… â€” å®Œç¾æ”¯æŒæ¨ªç«–å± */
      @media (max-width: 780px) {
        #game-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        #board-inner {
          width: 100vw;
          height: auto;
          aspect-ratio: 16 / 9;
          flex-shrink: 0;
        }

        #game-wrapper img.board-bg {
          width: 100%;
          height: 100%;
        }

        #control-panel {
          position: static;
          transform: none;
          flex-direction: row;
          flex-wrap: wrap;
          gap: 10px;
          z-index: 20;
          width: 100%;
          justify-content: center;
          margin-top: 10px;
          padding-bottom: 20px;
        }

        #step-label {
          display: block;
          font-size: 14px;
          margin-right: -8px;
        }
        #step-display {
          font-size: 24px;
          margin-right: 8px;
        }
        .btn {
          font-size: 12px;
          padding: 6px 10px;
          width: auto;
          min-width: 50px;
        }
        .floor-control {
          width: 100%;
          justify-content: center;
          order: 1;
        }
        .floor-control input {
          width: 100px;
          font-size: 14px;
        }

        /* ç§»åŠ¨ç«¯é“¾æ¥å®¹å™¨ */
        .repo-links {
          gap: 4px;
          right: 10px;
          top: 10px;
        }

        .repo-link {
          padding: 8px;
          width: 36px;
          height: 36px;
          justify-content: center;
          border-radius: 50%;
          gap: 0;
        }

        .repo-link svg:first-child {
          width: 20px;
          height: 20px;
          margin: 0;
        }

        .repo-link .star-icon,
        .repo-link .star-text {
          display: none;
        }
      }

      /* æ›´æ–°æ—¥å¿—å¼¹çª—æ ·å¼ */
      #changelog-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        z-index: 400;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
      }

      #changelog-overlay.show {
        display: flex;
      }

      #changelog-box {
        background: linear-gradient(135deg, #7b5e7b, #4a3f5a);
        border: 4px solid #e8b74a;
        border-radius: 20px;
        padding: 30px 40px;
        text-align: center;
        color: #fff;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        max-width: 500px;
      }

      #changelog-box h2 {
        font-size: 28px;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        color: #e8b74a;
      }

      #changelog-content {
        text-align: left;
        margin: 20px 0;
        font-size: 16px;
        line-height: 1.6;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 10px;
      }

      #changelog-content ul {
        padding-left: 20px;
      }

      #changelog-content li {
        margin-bottom: 5px;
      }

      .changelog-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      .changelog-buttons .btn {
        width: auto;
        padding: 8px 16px;
        font-size: 14px;
        background: rgba(0, 0, 0, 0.5);
        border-color: #e8b74a;
        color: #e8b74a;
      }

      .changelog-buttons .btn:hover {
        background: #e8b74a;
        color: #1a1a1a;
      }
    </style>
  </head>
  <body>
    <div id="game-wrapper">
      <div id="board-inner">
        <img class="board-bg" src="images/board1.png" alt="æ£‹ç›˜èƒŒæ™¯" />
        <div id="elevator-floor">1</div> <!-- é»˜è®¤æ˜¾ç¤º1æ¥¼ -->

        <!-- é“¾æ¥å®¹å™¨ï¼šåŸä»“åº“ + forkä»“åº“ + Bç«™ç•ªå‰§ -->
        <div class="repo-links">
          <!-- åŸä»“åº“é“¾æ¥ -->
          <a class="repo-link" href="https://github.com/fflow2023/BanGKlotski" target="_blank" rel="noopener">
            <svg viewBox="0 0 16 16">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
              />
            </svg>
            <svg class="star-icon" viewBox="0 0 16 16">
              <path
                d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z"
              />
            </svg>
            <span class="star-text">åŸé¡¹ç›®:Bç«™@å¿ƒä¹‹æµ_</span>
          </a>

          <!-- ä½ çš„ fork ä»“åº“é“¾æ¥ï¼ˆè¯·å°† href æ›¿æ¢ä¸ºä½ çš„å®é™…åœ°å€ï¼‰ -->
          <a class="repo-link fork-link" href="https://github.com/KasumiAmi/BanGKlotski_Enhanced" target="_blank" rel="noopener">
            <svg viewBox="0 0 16 16">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
              />
            </svg>
            <svg class="star-icon" viewBox="0 0 16 16">
              <path
                d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z"
              />
            </svg>
            <span class="star-text">Fork:Bç«™@åƒçŸ³Yunoé…±</span>
          </a>

          <!-- Bç«™ç•ªå‰§é“¾æ¥ï¼ˆå¸¦ç²‰è‰²è¾‰å…‰ï¼‰ -->
          <a class="repo-link bili-link" href="https://www.bilibili.com/bangumi/play/ss29308" target="_blank" rel="noopener">
            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <span class="star-text">ç¬¬19é›†:ç®±ä¸­ç±³æ­‡å°”</span>
          </a>
        </div>

        <div id="board"></div>
      </div>

      <div id="control-panel">
        <div id="step-label">æ­¥ æ•°</div>
        <div id="step-display">0</div>
        <button class="btn" id="btn-reset" onclick="resetGame()">é‡ ç½®</button>
        <button class="btn" id="btn-hint" onclick="getHint()">æ ç¤º</button>
        <button class="btn toggle-on" id="btn-voice" onclick="toggleVoice()">
          ğŸ¶è§’è‰²éŸ³æ•ˆ
        </button>

        <!-- è‡ªå®šä¹‰æ¥¼å±‚æ§ä»¶ -->
        <div class="floor-control">
          <input type="number" id="custom-floor" value="1" min="1" step="1">
          <button class="btn floor-btn" id="random-floor">éšæœº</button>
        </div>
      </div>
    </div>

    <div id="victory-overlay">
      <div id="victory-box">
        <h2>ğŸ‰ é€šå…³æˆåŠŸï¼</h2>
        <p>ç±³æ­‡å°”æˆåŠŸé€ƒå‡ºï¼ç”¨äº† <span id="victory-steps">0</span> æ­¥</p>
        <button class="btn" onclick="resetGame()">å†æ¥ä¸€å±€</button>
      </div>
    </div>

    <!-- æ›´æ–°æ—¥å¿—å¼¹çª— -->
    <div id="changelog-overlay">
      <div id="changelog-box">
        <h2>ğŸ“¢ æ›´æ–°æ—¥å¿— v1.1</h2>
        <div id="changelog-content">
          <ul>
            <li>æ–°å¢ï¼šè¿½åŠ æ›´å¤šè§’è‰²éŸ³æ•ˆä»¥åŠéƒ¨åˆ†æˆå‘˜çš„éšæœºæ’­æ”¾ï¼ˆå¤šæƒ ï¼Œæ‘©å¡ç­‰è§’è‰²å¤šè¯­éŸ³ï¼‰</li>
            <li>æ–°å¢ï¼šé‡ç½®æŒ‰é’®éŸ³æ•ˆ</li>
            <li>ä¼˜åŒ–ï¼šç§»åŠ¨ç«¯å¸ƒå±€é€‚é…æ¨ªç«–å±</li>
            <li>ä¿®å¤ï¼šéƒ¨åˆ†éŸ³æ•ˆæ— æ³•é¢„åŠ è½½çš„é—®é¢˜</li>
            <li>æ–°å¢ï¼šæ›´æ–°æ—¥å¿—å¼¹çª—ï¼ˆå°±æ˜¯æœ¬çª—å£ï¼‰</li>
          </ul>
        </div>
        <div class="changelog-buttons">
          <button class="btn" id="changelog-ok">æˆ‘~çŸ¥~é“~å•¦~</button>
          <button class="btn" id="changelog-skip">äº†è§£ æœ¬æ¬¡æ›´æ–°ä¸å†å¼¹å‡º</button>
          <button class="btn" id="changelog-ignore">æ°¸ä¹…å¿½ç•¥</button>
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // æ›´æ–°æ—¥å¿—é…ç½®
      // ============================================================
      const CHANGELOG_VERSION = 'v1.1'; // å½“å‰ç‰ˆæœ¬å·ï¼Œæ›´æ–°æ—¶ä¿®æ”¹
      const changelogOverlay = document.getElementById('changelog-overlay');

      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ›´æ–°æ—¥å¿—
      function shouldShowChangelog() {
        // æ°¸ä¹…å¿½ç•¥æ£€æŸ¥
        if (localStorage.getItem('changelog_permanent_ignore') === 'true') {
          return false;
        }
        // æœ¬æ¬¡æ›´æ–°ä¸å†å¼¹å‡ºæ£€æŸ¥
        const lastVersion = localStorage.getItem('changelog_last_version');
        if (lastVersion === CHANGELOG_VERSION) {
          return false;
        }
        return true;
      }

      // éšè—å¼¹çª—
      function hideChangelog() {
        changelogOverlay.classList.remove('show');
      }

      // æ˜¾ç¤ºå¼¹çª—
      function showChangelog() {
        changelogOverlay.classList.add('show');
      }

      // æŒ‰é’®äº‹ä»¶
      document.getElementById('changelog-ok').addEventListener('click', () => {
        hideChangelog();
        // ä¸åšä»»ä½•è®°å½•ï¼Œä¸‹æ¬¡åŠ è½½ä»ä¼šæ˜¾ç¤º
      });

      document.getElementById('changelog-skip').addEventListener('click', () => {
        hideChangelog();
        localStorage.setItem('changelog_last_version', CHANGELOG_VERSION);
      });

      document.getElementById('changelog-ignore').addEventListener('click', () => {
        hideChangelog();
        localStorage.setItem('changelog_permanent_ignore', 'true');
      });

      // ============================================================
      // æ•°æ®æ¨¡å‹
      // ============================================================
      const COLS = 4;
      const ROWS = 5;
      const GAP = 2;

      const TYPES = {
        "2x2": [2, 2],
        "1x2": [1, 2],
        "2x1": [2, 1],
        "1x1": [1, 1],
      };

      // åˆå§‹å¸ƒå±€ â€” å‚ç…§æ•ˆæœå›¾
      const INITIAL_LAYOUT = [
        { id: "michelle", type: "2x2", x: 1, y: 0, img: "images/michelle.png" },
        { id: "nyamu", type: "1x2", x: 0, y: 0, img: "images/nyamu.png" },
        { id: "moca", type: "1x2", x: 3, y: 0, img: "images/moca.png" },
        { id: "arisa", type: "1x2", x: 0, y: 2, img: "images/arisa.png" },
        { id: "yukina", type: "2x1", x: 1, y: 2, img: "images/yukina.png" },
        { id: "eve", type: "1x2", x: 3, y: 2, img: "images/eve.png" },
        { id: "saya", type: "1x1", x: 1, y: 3, img: "images/saya.png" },
        { id: "box", type: "1x1", x: 2, y: 3, img: "images/box.png" },
        { id: "otae", type: "1x1", x: 0, y: 4, img: "images/otae.png" },
        { id: "tsukushi", type: "1x1", x: 3, y: 4, img: "images/tsukushi.png" },
      ];

      // å½“å‰æ¸¸æˆçŠ¶æ€
      let blocks = [];
      let steps = 0;
      let solving = false;

      // æç¤ºç³»ç»ŸçŠ¶æ€
      let hintSolution = null;
      let hintIndex = 0;
      let hintStateKey = null;
      let hintWorker = null;
      let hintComputing = false;

      // æ‹–æ‹½çŠ¶æ€
      let dragState = null;

      // DOM å¼•ç”¨
      const boardEl = document.getElementById("board");
      const stepDisplay = document.getElementById("step-display");
      const victoryOverlay = document.getElementById("victory-overlay");
      const victorySteps = document.getElementById("victory-steps");
      const elevatorFloor = document.getElementById("elevator-floor");
      const customFloorInput = document.getElementById("custom-floor");
      const randomFloorBtn = document.getElementById("random-floor");

      // ============================================================
      // è‡ªå®šä¹‰æ¥¼å±‚åŠŸèƒ½
      // ============================================================
      function updateElevatorFloor(value) {
        // ç¡®ä¿ä¸ºæ­£æ•´æ•°
        let num = parseInt(value, 10);
        if (isNaN(num) || num < 1) num = 1;
        elevatorFloor.textContent = num;
        customFloorInput.value = num; // åŒæ­¥è¾“å…¥æ¡†
      }

      // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
      customFloorInput.addEventListener('input', (e) => {
        updateElevatorFloor(e.target.value);
      });

      // éšæœºæŒ‰é’®
      randomFloorBtn.addEventListener('click', () => {
        // ç”Ÿæˆ1~1000éšæœºæ•´æ•°ï¼ˆå¯è°ƒæ•´ä¸Šé™ï¼‰
        const randomNum = Math.floor(Math.random() * 1000) + 1;
        updateElevatorFloor(randomNum);
      });

      // ============================================================
      // æ¸²æŸ“
      // ============================================================
      function deepCloneLayout(layout) {
        return layout.map((b) => ({ ...b }));
      }

      function getCellSize() {
        const boardRect = boardEl.getBoundingClientRect();
        return {
          cellW: boardRect.width / COLS,
          cellH: boardRect.height / ROWS,
        };
      }

      function renderBoard() {
        boardEl.innerHTML = "";
        const { cellW, cellH } = getCellSize();

        blocks.forEach((block) => {
          const [w, h] = TYPES[block.type];
          const el = document.createElement("div");
          el.className = "block";
          el.id = "block-" + block.id;
          el.style.width = cellW * w - GAP * 2 + "px";
          el.style.height = cellH * h - GAP * 2 + "px";
          el.style.left = block.x * cellW + GAP + "px";
          el.style.top = block.y * cellH + GAP + "px";

          const img = document.createElement("img");
          img.src = block.img;
          img.alt = block.id;
          img.draggable = false;
          el.appendChild(img);

          // é¼ æ ‡æ‹–æ‹½
          el.addEventListener("mousedown", (e) => {
            e.preventDefault();
            startDrag(block.id, e.clientX, e.clientY);
          });

          // è§¦æ‘¸æ‹–æ‹½
          el.addEventListener("touchstart", (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            startDrag(block.id, touch.clientX, touch.clientY);
          });

          boardEl.appendChild(el);
        });
      }

      function updateBlockPosition(block) {
        const { cellW, cellH } = getCellSize();
        const el = document.getElementById("block-" + block.id);
        if (!el) return;
        el.style.left = block.x * cellW + GAP + "px";
        el.style.top = block.y * cellH + GAP + "px";
      }

      // ============================================================
      // æ‹–æ‹½äº¤äº’
      // ============================================================
      function startDrag(blockId, startX, startY) {
        if (solving) return;
        const block = blocks.find((b) => b.id === blockId);
        if (!block) return;

        const el = document.getElementById("block-" + blockId);
        el.classList.add("dragging");

        dragState = {
          blockId,
          startX,
          startY,
          origGridX: block.x,
          origGridY: block.y,
          moved: false,
        };
      }

      function onDragMove(clientX, clientY) {
        if (!dragState) return;

        const { cellW, cellH } = getCellSize();
        const dx = clientX - dragState.startX;
        const dy = clientY - dragState.startY;

        const threshold = Math.min(cellW, cellH) * 0.1;

        if (dragState.moved) return;

        let moveDx = 0;
        let moveDy = 0;

        if (Math.abs(dx) > Math.abs(dy)) {
          if (dx > threshold) moveDx = 1;
          else if (dx < -threshold) moveDx = -1;
        } else {
          if (dy > threshold) moveDy = 1;
          else if (dy < -threshold) moveDy = -1;
        }

        if (moveDx !== 0 || moveDy !== 0) {
          const success = moveBlock(dragState.blockId, moveDx, moveDy);
          if (success) dragState.moved = true;
        }
      }

      function endDrag() {
        if (!dragState) return;
        const el = document.getElementById("block-" + dragState.blockId);
        if (el) el.classList.remove("dragging");
        dragState = null;
      }

      document.addEventListener("mousemove", (e) => onDragMove(e.clientX, e.clientY));
      document.addEventListener("mouseup", endDrag);
      document.addEventListener("touchmove", (e) => {
        if (dragState) {
          e.preventDefault();
          const touch = e.touches[0];
          onDragMove(touch.clientX, touch.clientY);
        }
      }, { passive: false });
      document.addEventListener("touchend", endDrag);
      document.addEventListener("touchcancel", endDrag);

      // ============================================================
      // éŸ³æ•ˆç³»ç»Ÿ (ä½¿ç”¨éŸ³é¢‘æ–‡ä»¶)
      // ============================================================
      const audioCache = {};

      // è§’è‰²è¯­éŸ³é…ç½®ï¼šæ¯ä¸ªæˆå‘˜å¯é…ç½®å¤šä¸ªéŸ³æ•ˆæ–‡ä»¶ï¼Œç§»åŠ¨æ—¶éšæœºé€‰å–ä¸€ä¸ª
      const CHARACTER_AUDIO_MAP = {
        eve: ["images/eve.mp3"], // ç¤ºä¾‹ï¼šå¤šä¸ªè¯­éŸ³æ–‡ä»¶ï¼Œè¯·æ ¹æ®å®é™…ä¿®æ”¹
        otae: ["images/otae1.mp3","images/otae2.mp3"], 
        moca: ["images/moca1.mp3",'images/moca2.mp3'],
        nyamu: ["images/nyamu.mp3"],
        saya: ["images/saya.mp3"],
        yukina: ["images/ykn.mp3"],
        arisa: ["images/aras.mp3"],
        tsukushi: ["images/tsukushi.mp3"]// åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ™æ€»æ˜¯æ’­æ”¾å®ƒ
        // å¯ç»§ç»­æ·»åŠ å…¶ä»–è§’è‰²
      };

      // UI éŸ³æ•ˆï¼ˆé‡ç½®æŒ‰é’®ç­‰ï¼‰
      const UI_AUDIO_MAP = {
        reset: "images/reset.mp3", // é‡ç½®æŒ‰é’®éŸ³æ•ˆ
      };

      function tryPlayAudio(src) {
        if (!src) return;
        if (audioCache[src]) {
          const a = audioCache[src].cloneNode();
          a.volume = audioCache[src].volume || 0.6;
          a.play().catch(() => {});
          return;
        }

        const audio = new Audio(src);
        audio.volume = 0.6;

        const p = audio.play();
        if (p !== undefined) {
          p.then(() => {
            audioCache[src] = audio;
          }).catch((e) => {
            console.warn("Audio play failed or file not found:", src);
          });
        }
      }

      let voiceEnabled = true;

      function toggleVoice() {
        voiceEnabled = !voiceEnabled;
        const btn = document.getElementById("btn-voice");
        if (btn) {
          btn.classList.toggle("toggle-on", voiceEnabled);
        }
      }

      function playCharacterAudio(charId) {
        if (!voiceEnabled) return;
        const variants = CHARACTER_AUDIO_MAP[charId];
        if (!variants || variants.length === 0) return;
        const randomIndex = Math.floor(Math.random() * variants.length);
        tryPlayAudio(variants[randomIndex]);
      }

      const typeSoundMap = {
        "2x2": "images/2x2.mp3",
        "1x2": "images/1x2.mp3",
        "2x1": "images/1x2.mp3",
        "1x1": "images/1x1.mp3",
      };

      function playMoveSound(block) {
        const typeSound = typeSoundMap[block.type];
        if (typeSound) tryPlayAudio(typeSound);
        if (block.id !== "box") {
          playCharacterAudio(block.id);
        }
      }

      function playWinSound() {
        tryPlayAudio("images/win.mp3");
      }

      function playResetSound() {
        if (!voiceEnabled) return; // é‡ç½®éŸ³æ•ˆä¹Ÿå—è¯­éŸ³å¼€å…³æ§åˆ¶
        tryPlayAudio(UI_AUDIO_MAP.reset);
      }

      function preloadSounds() {
        const audioList = [
          "images/win.mp3",
          ...Object.values(typeSoundMap),
          ...Object.values(CHARACTER_AUDIO_MAP).flat(),
          UI_AUDIO_MAP.reset,
        ];
        const uniqueSrcs = [...new Set(audioList)];
        uniqueSrcs.forEach((src) => {
          if (src && !audioCache[src]) {
            const audio = new Audio();
            audio.src = src;
            audio.volume = 0.6;
            audio.load();
            audioCache[src] = audio;
          }
        });
      }

      // ============================================================
      // ç¢°æ’æ£€æµ‹ä¸ç§»åŠ¨
      // ============================================================

      function buildGrid(blocksState) {
        const grid = Array.from({ length: ROWS }, () => Array(COLS).fill(null));
        blocksState.forEach((b) => {
          const [w, h] = TYPES[b.type];
          for (let dy = 0; dy < h; dy++) {
            for (let dx = 0; dx < w; dx++) {
              grid[b.y + dy][b.x + dx] = b.id;
            }
          }
        });
        return grid;
      }

      function canMove(block, dx, dy, grid) {
        const [w, h] = TYPES[block.type];
        const nx = block.x + dx;
        const ny = block.y + dy;

        if (nx < 0 || ny < 0 || nx + w > COLS || ny + h > ROWS) return false;

        for (let r = 0; r < h; r++) {
          for (let c = 0; c < w; c++) {
            const occupant = grid[ny + r][nx + c];
            if (occupant !== null && occupant !== block.id) return false;
          }
        }
        return true;
      }

      function moveBlock(blockId, dx, dy) {
        const block = blocks.find((b) => b.id === blockId);
        if (!block) return false;

        const grid = buildGrid(blocks);
        if (!canMove(block, dx, dy, grid)) return false;

        block.x += dx;
        block.y += dy;
        updateBlockPosition(block);
        playMoveSound(block);

        if (!solving) {
          hintSolution = null;
          hintIndex = 0;
          hintStateKey = null;
          steps++;
          stepDisplay.textContent = steps;
        }

        if (block.id === "michelle" && block.x === 1 && block.y === 3) {
          setTimeout(() => {
            playWinSound();
            showVictory();
          }, 300);
        }

        return true;
      }

      function showVictory() {
        victorySteps.textContent = steps;
        victoryOverlay.classList.add("show");
      }

      function resetGame() {
        playResetSound(); // æ’­æ”¾é‡ç½®éŸ³æ•ˆ

        solving = false;
        steps = 0;
        stepDisplay.textContent = "0";
        victoryOverlay.classList.remove("show");
        blocks = deepCloneLayout(INITIAL_LAYOUT);
        hintSolution = null;
        hintIndex = 0;
        hintStateKey = null;
        hintComputing = false;
        if (hintWorker) {
          hintWorker.terminate();
          hintWorker = null;
        }
        const btnHint = document.getElementById("btn-hint");
        if (btnHint) {
          btnHint.disabled = false;
          btnHint.textContent = "æ ç¤º";
        }
        renderBoard();
        // é‡ç½®ç”µæ¢¯æ˜¾ç¤ºä¸º1
        updateElevatorFloor(1);
      }

      // ============================================================
      // æç¤ºç³»ç»Ÿ (Web Worker BFS)
      // ============================================================

      const workerCode = `
        const COLS = 4, ROWS = 5;
        const TYPES = { '2x2': [2,2], '1x2': [1,2], '2x1': [2,1], '1x1': [1,1] };
        // ç±»å‹ç¼–ç : 0=ç©º, 1=1x1, 2=1x2(å ä¸ŠåŠ), 3=1x2(å ä¸‹åŠ), 4=2x1(å å·¦åŠ), 5=2x1(å å³åŠ),
        //           6=michelleå·¦ä¸Š, 7=michelleå³ä¸Š, 8=michelleå·¦ä¸‹, 9=michelleå³ä¸‹

        function encodeState(bs) {
          const g = new Uint8Array(20);
          for (const b of bs) {
            const [w, h] = TYPES[b.type];
            if (b.id === 'michelle') {
              g[b.y * COLS + b.x] = 6;
              g[b.y * COLS + b.x + 1] = 7;
              g[(b.y + 1) * COLS + b.x] = 8;
              g[(b.y + 1) * COLS + b.x + 1] = 9;
            } else if (b.type === '1x1') {
              g[b.y * COLS + b.x] = 1;
            } else if (b.type === '1x2') {
              g[b.y * COLS + b.x] = 2;
              g[(b.y + 1) * COLS + b.x] = 3;
            } else if (b.type === '2x1') {
              g[b.y * COLS + b.x] = 4;
              g[b.y * COLS + b.x + 1] = 5;
            }
          }
          return String.fromCharCode.apply(null, g);
        }

        function buildGrid(bs) {
          const grid = [];
          for (let r = 0; r < ROWS; r++) grid[r] = new Array(COLS).fill(-1);
          for (let i = 0; i < bs.length; i++) {
            const b = bs[i];
            const [w, h] = TYPES[b.type];
            for (let dy = 0; dy < h; dy++)
              for (let dx = 0; dx < w; dx++)
                grid[b.y + dy][b.x + dx] = i;
          }
          return grid;
        }

        function canMove(b, dx, dy, grid, idx) {
          const [w, h] = TYPES[b.type];
          const nx = b.x + dx, ny = b.y + dy;
          if (nx < 0 || ny < 0 || nx + w > COLS || ny + h > ROWS) return false;
          for (let r = 0; r < h; r++)
            for (let c = 0; c < w; c++) {
              const occ = grid[ny + r][nx + c];
              if (occ !== -1 && occ !== idx) return false;
            }
          return true;
        }

        self.onmessage = function(e) {
          const startBlocks = e.data;
          const visited = new Set();
          const startKey = encodeState(startBlocks);
          visited.add(startKey);

          const queue = [startBlocks.map(b => ({...b}))];
          const parent = [null];
          let head = 0;

          const dirs = [[0,-1],[0,1],[-1,0],[1,0]];

          while (head < queue.length) {
            const state = queue[head];
            const michIdx = state.findIndex(b => b.id === 'michelle');

            if (state[michIdx].x === 1 && state[michIdx].y === 3) {
              const path = [];
              let cur = head;
              while (parent[cur] !== null) {
                const p = parent[cur];
                path.unshift({ id: queue[p.stateIdx][p.blockIdx].id, dx: p.dx, dy: p.dy });
                cur = p.stateIdx;
              }
              self.postMessage({ success: true, moves: path });
              return;
            }

            const grid = buildGrid(state);

            for (let bi = 0; bi < state.length; bi++) {
              const b = state[bi];
              for (const [dx, dy] of dirs) {
                if (!canMove(b, dx, dy, grid, bi)) continue;
                const ns = state.map(x => ({...x}));
                ns[bi] = {...ns[bi], x: ns[bi].x + dx, y: ns[bi].y + dy};
                const key = encodeState(ns);
                if (visited.has(key)) continue;
                visited.add(key);
                queue.push(ns);
                parent.push({ stateIdx: head, blockIdx: bi, dx, dy });
              }
            }
            head++;
          }

          self.postMessage({ success: false });
        };
      `;

      function getHint() {
        if (solving || hintComputing) return;

        const btnHint = document.getElementById("btn-hint");

        if (hintSolution && hintIndex < hintSolution.length) {
          const move = hintSolution[hintIndex];
          solving = true;
          moveBlock(move.id, move.dx, move.dy);
          steps++;
          stepDisplay.textContent = steps;
          solving = false;
          hintIndex++;
          if (hintIndex >= hintSolution.length) {
            hintSolution = null;
            hintStateKey = null;
          }
          return;
        }

        hintComputing = true;
        btnHint.disabled = true;
        btnHint.textContent = "æ€è€ƒä¸­â€¦";

        const blob = new Blob([workerCode], { type: "application/javascript" });
        const url = URL.createObjectURL(blob);
        hintWorker = new Worker(url);

        hintWorker.onmessage = function (e) {
          URL.revokeObjectURL(url);
          hintWorker = null;
          hintComputing = false;
          btnHint.disabled = false;
          btnHint.textContent = "æ ç¤º";

          if (e.data.success && e.data.moves.length > 0) {
            hintSolution = e.data.moves;
            hintIndex = 0;
            const move = hintSolution[hintIndex];
            solving = true;
            moveBlock(move.id, move.dx, move.dy);
            steps++;
            stepDisplay.textContent = steps;
            solving = false;
            hintIndex++;
            if (hintIndex >= hintSolution.length) {
              hintSolution = null;
              hintStateKey = null;
            }
          }
        };

        hintWorker.onerror = function () {
          URL.revokeObjectURL(url);
          hintWorker = null;
          hintComputing = false;
          btnHint.disabled = false;
          btnHint.textContent = "æ ç¤º";
          alert("æ±‚è§£å‡ºé”™ï¼Œè¯·é‡è¯•");
        };

        hintWorker.postMessage(deepCloneLayout(blocks));
      }

      // ============================================================
      // å¯åŠ¨
      // ============================================================
      window.addEventListener("load", () => {
        preloadSounds();
        resetGame();

        // æ˜¾ç¤ºæ›´æ–°æ—¥å¿—å¼¹çª—ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (shouldShowChangelog()) {
          showChangelog();
        }
      });

      window.addEventListener("resize", () => {
        renderBoard();
      });
    </script>
  </body>
</html>